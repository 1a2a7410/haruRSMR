<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>하루 리세계</title>
<meta property="og:title" content="하루 리세계">
<meta name="twitter:title" content="하루 리세계">
<meta name="application-name" content="하루 리세계">
<meta name="apple-mobile-web-app-title" content="하루 리세계">

<!-- 네트워크 힌트 -->
<link rel="preconnect" href="https://script.google.com" crossorigin>
<link rel="preconnect" href="https://drive.google.com" crossorigin>
<link rel="dns-prefetch" href="//drive.google.com">
<link rel="preconnect" href="https://lh3.googleusercontent.com" crossorigin>
<link rel="dns-prefetch" href="//lh3.googleusercontent.com">

<style>
  :root { --bg:#fafafa; --fg:#0f172a; --mut:#6b7280; --line:#e5e7eb; --pri:#111827; --back:#ffffffd9; --okbg:#d4edda; --okfg:#155724; --okbd:#c3e6cb; }
  * { box-sizing: border-box; }
  body { margin:0; font-family:-apple-system,BlinkMacSystemFont,'Noto Sans KR',Segoe UI,Roboto,Arial,sans-serif; color:var(--fg); background:var(--bg); }
  header { position:sticky; top:0; backdrop-filter:saturate(1.2) blur(6px); background:var(--back); border-bottom:1px solid var(--line); padding:10px 14px; z-index:10; }
  h1 { margin:0; font-size:28px; }
  .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; align-items:center; }
  input[type=text]{ padding:10px 12px; border:1px solid var(--line); border-radius:10px; min-width:160px; }
  select, button { padding:10px 12px; border:1px solid var(--pri); border-radius:10px; background:var(--pri); color:#fff; font-weight:700; cursor:pointer; }
  select { background:#fff; color:#0f172a; border-color:var(--line); }
  .btn.secondary { background:#fff; color:#0f172a; border:1px solid var(--line); }
  label.chk { display:flex; align-items:center; gap:6px; font-size:13px; color:#6b7280; }
  .counts { margin-left:auto; font-size:13px; color:#374151; }
  .chips { display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
  .chip { background:#f0fdf4; color:#065f46; border:1px solid #bbf7d0; border-radius:999px; padding:4px 8px; font-size:12px; cursor:pointer; user-select:none; }

  main { padding:12px 14px 90px; }
  .grid { display:grid; gap:4px; }
  @media (max-width:480px) { .grid { grid-template-columns: repeat(6, 1fr); } }
  @media (min-width:481px) and (max-width:900px) { .grid { grid-template-columns: repeat(12, 1fr); } }
  @media (min-width:901px) { .grid { grid-template-columns: repeat(14, 1fr); } }

  /* 아이템 카드 */
  .item {
    border:1px solid var(--line); border-radius:10px; background:#fff; padding:4px;
    display:flex; flex-direction:column; gap:6px; align-items:center; cursor:pointer; position:relative;

    /* 페인트/레이아웃 최적화 (오프스크린 지연 렌더링) */
    content-visibility:auto;
    contain-intrinsic-size: 180px 220px; /* 예상 크기 힌트(대략) */
  }
  .item img{
    display:block; width:100%;
    aspect-ratio:10/11;               /* 가로보다 세로 10% 길게 */
    height:auto; object-fit:cover;
    border-radius:8px; background:#f3f4f6;
    border:2px solid transparent;     /* 등급 테두리용 */
  }
  .item small{ padding:0 2px; color:#6b7280; font-size:11px; text-align:center; }
  .item.selected{ outline:2.5px solid #10b981; outline-offset:-1px; }

  /* +n 배지 (우상단, 약간 작게) */
  .item .badge{
    position:absolute; right:2px; top:2px;
    background:#f3f4f6; color:#6b7280; border:1px solid #e5e7eb;
    border-radius:999px; font-size:11px; padding:1px 5px; line-height:1; display:none;
  }
  .item.hasCount .badge{ display:inline-block; }

  /* 등급별 테두리 (이미지 자체) */
  .g4 { border-color:#de72fc !important; border-width:1.5px !important; border-style:solid !important; }
  .g5 { border-color:#ffea4a !important; border-width:1.5px !important; border-style:solid !important; }
  .g6 { border-color:#ffa347 !important; border-width:1.5px !important; border-style:solid !important; }

  .hint { margin:10px 0; color:#6b7280; font-size:13px; }

  /* 계정 카드 + 페인트 최적화 */
  .accounts { display:grid; gap:12px; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); margin-top:12px; }
  .acc {
    border:1px solid var(--line); background:#fff; border-radius:12px; padding:12px; cursor:pointer; contain:content;
    content-visibility:auto;
    contain-intrinsic-size: 260px 180px;
  }
  .acc h3 { margin:0 0 8px; font-size:16px; display:flex; justify-content:space-between; gap:8px; align-items:center; }
  .acc h3 .uid { font-weight:800; cursor:pointer; }
  .acc h3 .uid:hover { color:#0ea5e9; text-decoration:underline; }
  .price { font-weight:800; color:#111827; }
  .thumbs { display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
  /* 썸네일 고정 크기(리스트용) – 큰 이미지가 들어와도 항상 48x48로 */
  .thumbs img { width:48px; height:48px; border-radius:8px; object-fit:cover; background:#f3f4f6; }
  .thumbs .more { font-size:12px; color:#6b7280; }

  .sold { opacity:.55 }
  .pill { padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line); color:#374151; background:#f8fafc; }

  .loading { display:none; position:relative; top:0; left:0; color:#6b7280; font-weight:700; gap:8px; align-items:center; }
  .loading .bubbles { display:inline-flex; gap:2px; margin-right:4px; }
  .loading .bubbles i { width:6px; height:6px; border-radius:50%; background:#9ca3af; opacity:.3; animation:blink 1.2s infinite ease-in-out; display:block; }
  .loading .bubbles i:nth-child(2){ animation-delay:.15s; }
  .loading .bubbles i:nth-child(3){ animation-delay:.3s; }
  @keyframes blink { 0%,100%{ opacity:.25 } 40%{ opacity:.95 } }

  .flash { position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:var(--okbg); color:var(--okfg); border:1px solid var(--okbd); padding:10px 14px; border-radius:10px; font-weight:800; box-shadow:0 6px 24px rgba(0,0,0,.12); opacity:0; pointer-events:none; transition:opacity .25s ease; z-index:200; }
  .flash.on { opacity:1; }

  .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#111827; color:#fff; padding:10px 14px; border-radius:999px; font-size:13px; opacity:0; pointer-events:none; transition:.25s; z-index:60; }
  .toast.on { opacity:1; }

  .fab { position:fixed; right:12px; bottom:12px; display:flex; flex-direction:column; gap:10px; z-index:80; }
  .fab a, .fab button { padding:10px 12px; border-radius:999px; font-size:12px; font-weight:800; border:1px solid #0f172a; }
  .fab a { background:#0f172a; color:#fff; text-decoration:none; }
  .fab button { background:#fff; color:#0f172a; }
  .fab a:hover, .fab button:hover { opacity:.9; }
  .fab .mini { font-size:12px; padding:9px 12px; }

  .modal { position:fixed; inset:0; background:#0006; display:none; align-items:center; justify-content:center; padding:14px; z-index:100; }
  .modal.on { display:flex; }
  .modal .box { width:min(960px, 96vw); max-height:90vh; overflow:auto; background:#fff; border-radius:14px; border:1px solid var(--line); }
  .modal header { position:sticky; top:0; border-bottom:1px solid var(--line); background:#fff; display:flex; align-items:center; justify-content:space-between; padding:10px 12px; }
  .modal h3 { margin:0; font-size:16px; }
  .modal .close { background:#fff; color:#111827; border:1px solid var(--line); border-radius:10px; padding:8px 10px; cursor:pointer; }
  .help-body { padding:12px 14px 16px; }
  .help-body h2 { margin:0; font-size:18px; }
  .help-list { list-style: decimal; padding-left: 18px; margin:10px 18px 16px; color:#1f2937; line-height:1.6; }
  .help-list > li { margin:8px 0; position: relative; left: -6px; }
  .help-list ul { list-style: none; margin:6px 0 8px 18px; padding:0; }
  .help-list ul li { margin:6px 0; display:flex; align-items:flex-start; }
  .help-list ul li .bullet { display:inline-block; width:auto; color:#6b7280; margin-right:2px; }
  .help-body em { font-style:normal; color:#111827; font-weight:700; }

  .overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; gap:12px; background:#ffffff; z-index:110; }
  .spinner { width:26px; height:26px; border-radius:50%; border:3px solid #e5e7eb; border-top-color:#0ea5e9; animation:spin 0.9s linear infinite; }
  .overlay .txt { color:#0f172a; font-weight:800; }
  @keyframes spin { to { transform:rotate(360deg); } }

  .acc-modal .box { width:min(720px, 96vw); }
  .acc-detail { padding:12px 14px 16px; }
  .acc-detail .row { display:flex; align-items:center; gap:8px; margin:8px 0; flex-wrap:wrap; }

  /* 상세보기 썸네일 그리드(고정 6칸) + 텍스트 2줄 고정 */
  .acc-detail .thumbs{
    display:grid;
    grid-template-columns:repeat(6, 1fr);
    gap:6px 4px;
    justify-content:start;
  }
  @media (min-width:481px){
    .acc-detail .thumbs{ grid-template-columns:repeat(auto-fill, minmax(64px, 1fr)); }
  }
  .acc-detail .thumbs > *{
    display:flex; flex-direction:column; align-items:center; gap:4px; width:100%;
  }
  .acc-detail .thumbs img{
    display:block; width:100%;
    aspect-ratio:10/11; height:auto; object-fit:cover;
    border-radius:8px; background:#f3f4f6; border:1.5px solid transparent;
  }
  .acc-detail .thumbs small{
    display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
    width:100%; text-align:center; line-height:14px; height:28px;
    color:#6b7280; font-size:11px; word-break:keep-all;
  }
</style>
</head>
<body>
<header>
  <h1>브라운더스트2</h1>
  <div class="toolbar">
    <input id="uid-q" type="text" placeholder="UID 검색" autocomplete="off">
    <select id="sort" aria-label="정렬">
      <option value="">정렬 없음</option>
      <option value="price_desc">가격 높은 순</option>
      <option value="price_asc">가격 낮은 순</option>
      <option value="count_desc">5성 캐릭터 많은 순</option>
      <option value="count_asc">5성 캐릭터 적은 순</option>
    </select>
    <label class="chk"><input type="checkbox" id="hide-sold"> 판매완료 숨기기</label>
    <button id="btn-search">검색</button>
    <button id="btn-clear" class="btn secondary">선택취소</button>
    <div style="flex-basis:100%; height:0;"></div>
    <span id="loading" class="loading"><span class="bubbles"><i></i><i></i><i></i></span><span class="txt">불러오는중…</span></span>
    <div id="counts" class="counts" aria-live="polite">총 매물 – | 결과 –</div>
  </div>
  <div id="chips" class="chips"></div>
</header>

<main>
  <h2 style="font-size:16px;margin:10px 0 6px;">아이템</h2>
  <div id="items" class="grid" aria-live="polite"></div>

  <div class="hint" id="hint-acc">검색을 누르면 매물을 불러옵니다.</div>
  <h2 style="font-size:16px;margin:16px 0 6px;">계정</h2>
  <div id="accounts" class="accounts"></div>
</main>

<div id="toast" class="toast">복사됨</div>
<div id="flash" class="flash">검색완료</div>

<div class="fab">
  <a id="btn-buy" class="mini" href="#" target="_blank" rel="noopener">구매 문의</a>
  <button id="btn-help" class="mini" type="button">사용 설명서</button>
</div>

<!-- Help Modal -->
<div id="help-modal" class="modal" aria-hidden="true">
  <div class="box">
    <header>
      <h3>사용 설명서</h3>
      <button id="help-close" class="close" type="button">닫기</button>
    </header>
    <div class="help-body">
      <h2>구매 가이드</h2>
      <ol class="help-list">
        <li><strong>캐릭터 선택</strong>: 상단 카드에서 원하는 캐릭터를 눌러 선택하세요. 여러 개 선택하면 <em>해당 캐릭터를 모두 포함</em>하는 계정만 검색됩니다.</li>
        <li><strong>UID/판매상태/정렬</strong>:
          <ul>
            <li><span class="bullet">•</span>UID: 판매자가 관리용으로 붙인 고유 번호입니다. 일부 숫자만 입력해도 포함 검색됩니다.</li>
            <li><span class="bullet">•</span>판매완료 숨기기: 이미 판매된 계정을 리스트에서 숨깁니다.</li>
            <li><span class="bullet">•</span>정렬: 가격 또는 포함 캐릭터 수 기준으로 오름/내림차순 정렬합니다.</li>
          </ul>
        </li>
        <li><strong>검색 & 확인</strong>:
          <ul>
            <li><span class="bullet">•</span>검색 결과 카드에서 포함 캐릭터와 가격, 부가설명을 확인하세요.</li>
            <li><span class="bullet">•</span>원하는 계정의 uid를 복사한 뒤 판매자의 오픈카카오톡으로 문의하세요.</li>
          </ul>
        </li>
        <li><strong>주의 사항</strong>:
          <ul>
            <li><span class="bullet">•</span>상세한 캐릭터 목록 및 아이템 현황은 실시간으로 변경될 수 있습니다.</li>
            <li><span class="bullet">•</span>구매후 24시간 이전에 발생한 문제에 대해서는 보상을 해 드리며, 24시간 이후에 발생한 문제에 대해서는 책임지지 않습니다.</li>
          </ul>
        </li>
      </ol>
    </div>
  </div>
</div>

<!-- Account Modal -->
<div id="acc-modal" class="modal acc-modal" aria-hidden="true">
  <div class="box">
    <header>
      <h3>계정 상세</h3>
      <button id="acc-close" class="close" type="button">닫기</button>
    </header>
    <div class="acc-detail" id="acc-detail"></div>
  </div>
</div>

<div id="overlay" class="overlay" aria-hidden="false">
  <div class="spinner" aria-hidden="true"></div>
  <div class="txt" aria-live="polite">로딩중</div>
</div>

<script>
const API_BASE = 'https://script.google.com/macros/s/AKfycbziMLW8TUgzTFnrYJFpW9u3AQmnWPeyDofFbrnKrn6ECjMNMWCpRrhkNG-OJGojM6TJ/exec';
const KAKAO = "https://open.kakao.com/o/sENDKZBh";
const PLACEHOLDER = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'><rect width='100%' height='100%' fill='%23eef'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='12' fill='%23999'>no image</text></svg>";

const $ = (q)=>document.querySelector(q);
function h(html){ const d=document.createElement('div'); d.innerHTML=html.trim(); return d.firstChild; }
function cleanUrl(u){ if(!u) return u; if(/\.jrg$/i.test(u)) u=u.replace(/\.jrg$/i,'.jpg'); return u; }

/* 원본 코드 변수들 */
let itemsMap = new Map(); // name -> { url, grade(4|5|6) }
let accounts = null;
let selected = new Map(); // name -> count (1..7)

/* 캐시/토큰 */
const accMeta = new WeakMap(); // acc -> { items:string[], count:number }
let renderToken = 0;

/* 등급 보조 */
const G_ORDER = {6:3, 5:2, 4:1, 0:0};
function toGrade(v){ const n = Number(v); return (n===4||n===5||n===6) ? n : 0; }
function gradeClass(g){ return g===6?'g6' : g===5?'g5' : g===4?'g4' : ''; }

/* 오버레이 안전히 닫기 */
function hideOverlay(){ const ov = document.getElementById('overlay'); if (ov) { ov.style.display='none'; ov.setAttribute('aria-hidden','true'); } }

/* 계정 아이템 추출 */
function getAccItems(acc){
  const c = accMeta.get(acc);
  if (c) return c.items;
  const arr=[]; for(const k in acc){ if(/^포함아이템\d+$/.test(k)){ const v=(acc[k]||'').toString().trim(); if(v) arr.push(v); } }
  accMeta.set(acc,{items:arr,count:arr.length}); return arr;
}
function getAccCount(acc){ const c = accMeta.get(acc); return c ? c.count : getAccItems(acc).length; }

/* 카운트/칩 */
function updateCounts(total, matched){ document.getElementById('counts').textContent = `총 매물 ${total ?? '–'} | 결과 ${matched ?? '–'}`; }
function itemCount(name){ return selected.get(name) || 0; }
function setItemCount(name, next){ if(next<=0) selected.delete(name); else selected.set(name, Math.min(7,next)); }
function chipLabel(name, cnt){ return cnt>=2 ? `${name} +${cnt-1}` : name; }
function updateChips(){
  const box = document.getElementById('chips'); box.innerHTML='';
  if(!selected.size) return;
  for(const [name,cnt] of selected){
    const chip = h(`<span class="chip">${chipLabel(name,cnt)}</span>`);
    chip.addEventListener('click', ()=>{
      const cur = itemCount(name);
      const next = cur-1;
      setItemCount(name, next);
      renderItemBadges();
      updateChips();
    });
    box.appendChild(chip);
  }
}

/* 선택 배지/하이라이트 */
function renderItemBadges(){
  document.querySelectorAll('.item').forEach(card=>{
    const name = card.getAttribute('data-name');
    const cnt = itemCount(name);
    const badge = card.querySelector('.badge');
    if(cnt >= 2){ badge.textContent = `+${cnt-1}`; card.classList.add('hasCount'); card.classList.add('selected'); }
    else { badge.textContent=''; card.classList.remove('hasCount'); card.classList.toggle('selected', cnt>=1); }
  });
}

/* 이미지 URL 그대로 사용 (필요시 파라미터 최적화 훅) */
function gridSrc(url){ return url; }

/* 아이템 렌더 (초기 24장 eager) */
async function renderItems(list){
  // 등급 정렬: 6 → 5 → 4
  list.sort((a,b)=>{
    const ga = toGrade(a['등급']||a['grade']);
    const gb = toGrade(b['등급']||b['grade']);
    return G_ORDER[gb]-G_ORDER[ga];
  });

  const box = document.getElementById('items'); box.innerHTML='';
  const frag = document.createDocumentFragment();

  let index = 0; // eager/lazy 전환용

  for(const it of list){
    const name = it['아이템명'] || it['name'] || '';
    const img  = cleanUrl((it['이미지URL'] || it['url'] || '').toString().trim());
    const g    = toGrade(it['등급']||it['grade']);
    const cls  = gradeClass(g);

    const eager = index < 24; index++;

    const card = h(`<div class="item" data-name="${name}">
      <span class="badge"></span>
      <img class="${cls}"
           ${eager ? 'loading="eager" fetchpriority="high"' : 'loading="lazy" fetchpriority="low"'}
           decoding="async" referrerpolicy="no-referrer"
           src="${gridSrc(img) || PLACEHOLDER}" alt="${name}"
           onerror="this.src='${PLACEHOLDER}'">
      <small>${name}</small>
    </div>`);

    card.addEventListener('click', ()=>{
      const cur = itemCount(name);
      const next = (cur>=7) ? 0 : cur+1;
      setItemCount(name, next);
      updateChips();
      renderItemBadges();
    });

    frag.appendChild(card);
  }
  box.appendChild(frag);
  renderItemBadges();
}

/* 필터/정렬 */
function applyFilters(list){
  const q = document.getElementById('uid-q').value.trim();
  const hide = document.getElementById('hide-sold').checked;
  const want = new Map(selected);
  return list.filter(a=>{
    if(q && !String(a['UID']||'').includes(q)) return false;
    if(hide && (a['판매상태']||'')==='판매완료') return false;
    if(want.size){
      const have=new Map();
      for(const n of getAccItems(a)){ have.set(n,(have.get(n)||0)+1); }
      for(const [n,c] of want){ if((have.get(n)||0) < c) return false; }
    }
    return true;
  });
}
function sortResults(list){
  const v = document.getElementById('sort').value;

  // 각 계정에 대해 가격/총개수/5성개수 계산
  const ext = list.map(a=>{
    const names = getAccItems(a);
    const fiveCount = names.filter(n => gradeOfName(n) === 5).length;
    const price = Number(a['가격'] || 0);
    const cnt = getAccCount(a);
    return { a, price, cnt, fiveCount };
  });

  if (v === 'price_desc') ext.sort((x,y)=> y.price - x.price);
  if (v === 'price_asc')  ext.sort((x,y)=> x.price - y.price);
  if (v === 'count_desc') ext.sort((x,y)=> y.fiveCount - x.fiveCount); // 5성 많은 순
  if (v === 'count_asc')  ext.sort((x,y)=> x.fiveCount - y.fiveCount); // 5성 적은 순

  return ext.map(x=>x.a);
}
function gradeOfName(name){ const meta = itemsMap.get(name); return meta ? meta.grade : 0; }

/* 계정 리스트(청크 렌더) */
function renderAccountsChunked(list){
  const box = document.getElementById('accounts');
  box.innerHTML = '';

  if (!list.length) {
    box.innerHTML = '<p class="chip" style="background:#fff;border-color:#e5e7eb;color:#6b7280;">조건에 맞는 계정이 없습니다.</p>';
    updateCounts(accounts?.length || 0, 0);
    return;
  }

  const myToken = ++renderToken;
  const CHUNK = 80;
  let i = 0;

  function draw(){
    if (myToken !== renderToken) return;

    const frag = document.createDocumentFragment();
    const end = Math.min(i + CHUNK, list.length);

    for (; i < end; i++) {
      const acc = list[i];
      const names = getAccItems(acc).slice().sort((a,b)=>G_ORDER[gradeOfName(b)]-G_ORDER[gradeOfName(a)]);

let c4 = 0, c5 = 0;
for (const n of names) {
  const g = gradeOfName(n);
  if (g === 5) c5++;
  else if (g === 4) c4++;
}

      const thumbs = names.slice(0, 11).map(n => {
        const meta = itemsMap.get(n) || {url:'',grade:0};
        const url  = (meta.url || '').toString().trim() || PLACEHOLDER;
        const cls  = gradeClass(meta.grade);
        return `<img class="${cls}" loading="lazy" decoding="async" fetchpriority="low"
                     referrerpolicy="no-referrer"
                     src="${url}" alt="${n}" title="${n}"
                     onerror="this.src='${PLACEHOLDER}'">`;
      }).join('');

      const more = names.length > 11 ? `<span class="more">+${names.length - 11}</span>` : '';

      const sold  = (acc['판매상태'] || '') === '판매완료';
      const price = Number(acc['가격'] || 0).toLocaleString('ko-KR');
      const uid   = acc['UID'] || '';
      const desc  = acc['부가설명'] || '';

      const card = h(`<div class="acc ${sold ? 'sold' : ''}" role="button">
        <h3>
          <span class="uid" title="탭하면 복사">${uid}</span>
          <span class="price">${price}원</span>
        </h3>
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
  <span class="pill">${sold ? '판매완료' : '판매중'}</span>
  <span class="mut">${desc}</span>
  <span class="mut">· 5성 ${c5}개 · 4성 ${c4}개</span>
</div>
        <div class="thumbs">${thumbs}${more}</div>
      </div>`);

      card.querySelector('.uid').addEventListener('click', async (e)=>{
        e.stopPropagation();
        try { await navigator.clipboard.writeText(uid); showToast('UID 복사됨'); }
        catch { showToast('복사 실패'); }
      });

      card.addEventListener('click', ()=> openAccModal(acc, names));

      frag.appendChild(card);
    }

    box.appendChild(frag);
    updateCounts(accounts.length, list.length);

    if (i < list.length) { (window.requestIdleCallback || window.requestAnimationFrame || setTimeout)(draw, 0); }
  }

  (window.requestIdleCallback || window.requestAnimationFrame || setTimeout)(draw, 0);
}

/* 검색 */
async function runSearch(){
  document.getElementById('loading').style.display = 'inline-flex';
  document.getElementById('hint-acc').style.display = 'none';
  try {
    await loadAccountsIfNeeded();
    const filtered = sortResults(applyFilters(accounts));
    renderAccountsChunked(filtered);
  } catch (e) { console.warn(e); }
  finally { document.getElementById('loading').style.display = 'none'; flashDone(); }
}

/* 토스트/플래시 */
function showToast(msg='복사됨'){ const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('on'); setTimeout(()=> t.classList.remove('on'), 1100); }
function flashDone(){ let f = document.getElementById('flash'); f.classList.add('on'); clearTimeout(f._t); f._t=setTimeout(()=> f.classList.remove('on'), 650); }

/* 이벤트 */
document.getElementById('btn-search').addEventListener('click', runSearch);
document.getElementById('btn-clear').addEventListener('click', ()=>{
  selected.clear(); updateChips();
  renderItems(Array.from(itemsMap, ([아이템명, meta])=>({아이템명, 이미지URL: meta.url, 등급: meta.grade})));
});
document.getElementById('btn-buy').setAttribute('href', KAKAO);
document.getElementById('btn-help').addEventListener('click', ()=>{ const m = document.getElementById('help-modal'); m.classList.add('on'); m.setAttribute('aria-hidden','false'); });
document.getElementById('help-close').addEventListener('click', ()=>{ const m = document.getElementById('help-modal'); m.classList.remove('on'); m.setAttribute('aria-hidden','true'); });
document.getElementById('acc-close').addEventListener('click', ()=>{ const m = document.getElementById('acc-modal'); m.classList.remove('on'); m.setAttribute('aria-hidden','true'); });
document.getElementById('acc-modal').addEventListener('click', (e)=>{ if(e.target.id==='acc-modal'){ const m=e.currentTarget; m.classList.remove('on'); m.setAttribute('aria-hidden','true'); } });

/* 상세 모달 */
function openAccModal(acc, names){
  const modal = document.getElementById('acc-modal');
  const box = document.getElementById('acc-detail');
  const uid = acc['UID']||'';
  const desc = acc['부가설명']||'';
  const price = Number(acc['가격']||0).toLocaleString('ko-KR');

  const sorted = names.slice().sort((a,b)=>G_ORDER[gradeOfName(b)]-G_ORDER[gradeOfName(a)]);

  const thumbs = sorted.map(n=>{
    const meta = itemsMap.get(n) || {url:'',grade:0};
    const url  = (meta.url || '').toString().trim() || PLACEHOLDER;
    const cls  = gradeClass(meta.grade);
    return `<div style="display:flex;flex-direction:column;align-items:center;gap:4px">
      <img class="${cls}" loading="lazy" decoding="async" referrerpolicy="no-referrer" src="${url}" alt="${n}" title="${n}" onerror="this.src='${PLACEHOLDER}'">
      <small style="color:#6b7280;font-size:11px;text-align:center;max-width:100%;word-break:keep-all">${n}</small>
    </div>`;
  }).join('');

  box.innerHTML = `
    <div class="row"><span class="label">UID</span><strong style="font-size:15px">${uid}</strong></div>
    <div class="row"><span class="label">모든 캐릭터 현황</span></div>
    <div class="thumbs" style="margin:2px 0 8px">${thumbs}</div>
    <div class="row"><span class="label">상세설명:</span><span>${desc||'-'}</span></div>
    <div class="row"><span class="label">가격</span><strong>${price}원</strong></div>
  `;
  modal.classList.add('on'); modal.setAttribute('aria-hidden','false');
}

/* 네트워크 */
async function fetchJSON(url, signal){
  const r = await fetch(url, { signal, cache: 'no-store' });
  const txt = await r.text();
  try { return JSON.parse(txt); }
  catch(e){ console.warn('JSON parse error:', txt.slice(0, 200)); throw new Error('JSON parse error'); }
}

/* 부트 */
let ctrlItems = null;
async function loadItems(){
  ctrlItems && ctrlItems.abort();
  ctrlItems = new AbortController();
  try {
    const list = await fetchJSON(API_BASE + "?sheet=items", ctrlItems.signal);
    itemsMap = new Map(list.map(it=>{
      const name = it['아이템명']||it['name'];
      const url  = (it['이미지URL']||it['url']||'').toString().trim();
      const g    = toGrade(it['등급']||it['grade']);
      return [name, { url, grade: g }];
    }));
    requestAnimationFrame(()=> renderItems(list));
  } catch (e) {
    console.warn('items load failed', e);
    requestAnimationFrame(()=> renderItems([]));
    showToast('아이템 로드 실패 · 다시 시도하세요');
  } finally {
    hideOverlay();
    updateCounts(undefined, undefined);
  }
}

let ctrlAcc = null;
async function loadAccountsIfNeeded(){
  if (accounts) return accounts;
  ctrlAcc && ctrlAcc.abort();
  ctrlAcc = new AbortController();
  const list = await fetchJSON(API_BASE + "?sheet=accounts", ctrlAcc.signal);
  accounts = list || [];
  return accounts;
}

(async function boot(){
  const killer = setTimeout(hideOverlay, 5000);
  try{ await loadItems(); }
  catch(e){ console.warn('boot failed', e); }
  finally{ clearTimeout(killer); hideOverlay(); }
})();
</script>
</body>
</html>